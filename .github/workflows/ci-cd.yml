name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Ejecuta el pipeline en cada push a la rama main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout cÃ³digo fuente
        uses: actions/checkout@v3

      - name: ðŸ”§ Configurar JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“‚ Listar archivos despuÃ©s de checkout (opcional para depuraciÃ³n)
        run: ls -R

      - name: ðŸ“¦ Dar permisos de ejecuciÃ³n al wrapper de Gradle
        run: chmod +x gradlew  # Asegurar que el wrapper de Gradle puede ejecutarse

      - name: ðŸ—ï¸ Compilar aplicaciÃ³n con Gradle
        run: ./gradlew build -x test  # Construir sin ejecutar pruebas

      - name: ðŸ” Obtener la Ãºltima versiÃ³n en Docker Hub
        run: |
          VERSIONES=$(curl -s "https://hub.docker.com/v2/repositories/nicolasortiz05/back-taller/tags" | jq -r '.results[].name' | grep -E '^[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          if [[ -z "$VERSIONES" ]]; then
            NUEVA_VERSION="1.0"
          else
            NUEVA_VERSION=$(echo $VERSIONES | awk -F. '{print $1"."$2+1}')
          fi
          echo "Nueva versiÃ³n: $NUEVA_VERSION"
          echo "NUEVA_VERSION=$NUEVA_VERSION" >> $GITHUB_ENV

      - name: ðŸ”¨ Construir imagen Docker
        run: |
          docker build -t nicolasortiz05/back-taller:${{ env.NUEVA_VERSION }} .
          docker build -t nicolasortiz05/back-taller:latest .

      - name: ðŸ”‘ Login en Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸš€ Subir imagen a Docker Hub
        run: |
          docker push nicolasortiz05/back-taller:${{ env.NUEVA_VERSION }}
          docker push nicolasortiz05/back-taller:latest


      - name: ðŸ”„ Actualizar kustomization.yaml en el repositorio de configuraciÃ³n
        run: |
          # Clonar el repositorio de configuraciÃ³n de ArgoCD
          git clone https://github.com/NicolasOrtiz05/back_taller_argocd.git
          cd back_taller_argocd
          
          # Actualizar el newTag en kustomization.yaml con la nueva versiÃ³n
          sed -i "s/newTag: .*/newTag: \"${{ env.NUEVA_VERSION }}\"/" kustomization.yaml
          
          # Configurar Git para commit
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          git add kustomization.yaml
          git commit -m "ðŸš€ Actualizando imagen a versiÃ³n ${{ env.NUEVA_VERSION }}"
